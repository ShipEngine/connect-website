<% if (hasBuild) { %>
FROM node:lts-alpine as builder
ARG PROJECT_ROOT=.
WORKDIR /srv
COPY ${PROJECT_ROOT}/ ./
RUN npm ci --no-progress
RUN npm run-script build

<% } %>FROM node:lts-alpine as runtime
ARG PROJECT_ROOT=.
# This sets our os package dependencies up for NewRelic 
RUN set -ex; \
    apk add --no-cache build-base python; \
    apk add --no-cache ca-certificates tini; \
    npm install --no-progress --global node-gyp;
ENV CXXFLAGS='-Wno-cast-function-type'
WORKDIR /
<% if (hasBuild) { %>
COPY --from=builder /srv/lib ./lib
COPY --from=builder /srv/package.json /srv/package-lock.json ./
<% } else { %>
COPY ./package.json ./package-lock.json ./
<% } %>
RUN npm ci --no-progress --production
ARG GIT_SHA
ARG GIT_BRANCH
ENV GIT_SHA ${GIT_SHA:-snapshot}
ENV GIT_BRANCH ${GIT_BRANCH:-some-branch}
ENV MODULE_NAME ${MODULE_NAME:-module}
ENV NEW_RELIC_NO_CONFIG_FILE ${NEW_RELIC_NO_CONFIG_FILE:-true}
ENV PORT 3000
EXPOSE 3000
ENTRYPOINT [ "/sbin/tini", "--" ]

CMD [ "npm", "run", "start" ]
